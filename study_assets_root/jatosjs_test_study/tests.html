<!DOCTYPE html>
<html>

<head>
    <script src="libs/jquery-1.11.1.min.js"></script>
    <script src="jatos.js"></script>
</head>

<body>
    <button id="startNextComponent"
        onclick="jatos.startNextComponent(' ... append before jatos.startNextComponent', 'msg via message parameter')">jatos.startNextComponent</button>
    <button id="startLastComponent"
        onclick="jatos.startLastComponent(' ... append before jatos.startLastComponent', 'msg via message parameter')">jatos.startLastComponent</button>
    <button id="startComponentByPos"
        onclick="jatos.startComponentByPos(1, ' ... append before jatos.startComponentByPos', 'msg via message parameter')">jatos.startComponentByPos</button>
    <button id="abortStudyAjax" onclick="callAbortStudyAjax()">jatos.abortStudyAjax</button>
    <button id="abortStudy" onclick="jatos.abortStudy('Test study was aborted')">jatos.abortStudy</button>
    <button id="endStudyAjax" onclick="callEndStudyAjax()">jatos.endStudyAjax</button>
    <button id="endStudyNoShowEndPage"
        onclick="jatos.endStudy({obj:'endStudy noshowendpage append'}, true, 'Test study was finished via Ajax and no end page shown', false)">jatos.endStudy
        no end page</button>
    <button id="endStudy"
        onclick="jatos.endStudy({obj:'endStudy append'}, true, 'Test study was finished')">jatos.endStudy</button>
    <button id="endStudy"
        onclick="jatos.endStudyAndRedirect('http\:\/\/jatos.org', {obj:'endStudyAndRedirect append'}, true, 'Test study was finished')">jatos.endStudyAndRedirect</button>
    <p class="test">Loading study assets with absolute path: <img src="你经常来这吗.png"
            alt="Not loaded img with absolute path" height="42" width="42"></p>
    <p class="test">Loading study assets with relative path: <img src="你经常来这吗.png"
            alt="Not loaded img with absolute path" height="42" width="42"></p>

    <script type="text/javascript">
        jatos.catchAndLogErrors();

        jatos.addAbortButton({
            text: "Quit",
            confirm: true,
            confirmText: "You really wanne quit?",
            tooltip: "Don't you dare clicking here!",
            msg: "This bastard aborted the mission.",
            style: "color:green"
        });

        var howOftenWasJatosOnLoadCalled = 0;
        jatos.onload(() => { howOftenWasJatosOnLoadCalled++ });
        jatos.onload(() => { howOftenWasJatosOnLoadCalled++ });
        jatos.onLoad(() => {
            howOftenWasJatosOnLoadCalled++;
            testVar(howOftenWasJatosOnLoadCalled, "jatos.onLoad multiple callbacks", 3);
        });

        jatos.onLoad(async function () {
            testJatosVars();
            testBatchSession();
            testGroupSession();
            await testSubmitResultData();
            await testAppendResultData();
            testJatosLog();
            await testUpload();
            await testDownload();
            await testSetStudySessionData();
            testHttpLoopCounter();
            checkTestNumber();
        });

        function testJatosVars() {
            testVar(jatos.version, "jatos.version");
            testVar(jatos.httpTimeout, "jatos.httpTimeout", 30000);
            testVar(jatos.httpRetry, "jatos.httpRetry", 5);
            testVar(jatos.httpRetryWait, "jatos.httpRetryWait", 1000);
            testVarJson(jatos.studyJsonInput, "jatos.studyJsonInput",
                '{"sa":"test","sb":5,"sc":[1,2,3],"sd":{"se":"foo","sf":"bla"}}');
            testVar(jatos.studyLength, "jatos.studyLength", 1);
            testVar(jatos.studyProperties.id, "jatos.studyProperties.id");
            testVar(jatos.studyProperties.uuid, "jatos.studyProperties.uuid", "79d0a52a-d5d3-4461-9d9b-6fd9f386c04a");
            testVar(jatos.studyProperties.description, "jatos.studyProperties.description",
                "Tests for JATOS' jatos.js development");
            testVar(jatos.studyProperties.descriptionHash, "jatos.studyProperties.descriptionHash",
                "a7da5fc6d901a2f7d9a1b95d62843f62fec9e913d1e3e359721a60203ea31dac");
            testVar(jatos.studyProperties.dirName, "jatos.studyProperties.dirName", "jatosjs_test_study");
            testVar(jatos.studyProperties.groupStudy, "jatos.studyProperties.groupStudy", true);
            testVar(jatos.studyProperties.locked, "jatos.studyProperties.locked", false);
            testVar(jatos.studyProperties.title, "jatos.studyProperties.title", "jatos.js Test Study");
            testVarJson(jatos.studySessionData, "jatos.studySessionData");
            jatos.componentList.length === 1 ? addSuccess("jatos.componentList") : addFail("jatos.componentList");
            testVarJson(jatos.componentJsonInput, "jatos.componentJsonInput",
                '{"ca":"test","cb":5,"cc":[1,2,3],"cd":{"ce":"foo","cf":"bla"}}');
            testVar(jatos.componentPos, "jatos.componentPos", 1);
            testVar(jatos.componentProperties.id, "jatos.componentProperties.id");
            testVar(jatos.componentProperties.uuid, "jatos.componentProperties.uuid",
                "15287b49-d9e1-4d20-85c8-a412c9ac2075");
            testVar(jatos.componentProperties.title, "jatos.componentProperties.title", "Tests");
            testVar(jatos.componentProperties.htmlFilePath, "jatos.componentProperties.htmlFilePath", "tests.html");
            testVar(jatos.componentProperties.reloadable, "jatos.componentProperties.reloadable", true);
            testVar(jatos.batchProperties.id, "jatos.batchProperties.id");
            testVar(jatos.batchProperties.title, "jatos.batchProperties.title", "Default");
            testVar(jatos.batchProperties.maxActiveMembers, "jatos.batchProperties.maxActiveMembers", 1);
            testVar(jatos.batchProperties.maxTotalMembers, "jatos.batchProperties.maxTotalMembers", null);
            testVar(jatos.batchProperties.maxTotalWorkers, "jatos.batchProperties.maxTotalWorkers", null);
            testVarJson(jatos.batchProperties.allowedWorkerTypes, "jatos.batchProperties.allowedWorkerTypes",
                '["PersonalSingle","Jatos","PersonalMultiple"]');
            testVarJson(jatos.batchJsonInput, "jatos.batchJsonInput",
                '{"a":"test","b":5,"c":[1,2,3],"d":{"e":"foo","f":"bla"}}');
            testVarJson(jatos.groupMemberId, "jatos.groupMemberId");
            testVarJson(jatos.groupResultId, "jatos.groupResultId");
            testVarJson(jatos.groupMembers, "jatos.groupMembers");
            testVarJson(jatos.groupChannels, "jatos.groupChannels");
            testVar(jatos.channelSendingTimeoutTime, "jatos.channelSendingTimeoutTime", 10000);
            testVarJson(jatos.jQuery, "jatos.jQuery");
            testVarJson(jatos.batchSession, "jatos.batchSession");
            testVarJson(jatos.groupSession, "jatos.groupSession", "{}");
        }

        function testVarJson(variable, name, value) {
            if (typeof value == 'undefined' && typeof variable == 'undefined') {
                addFail(name);
            } else if (typeof value != 'undefined' && value !== JSON.stringify(variable)) {
                addFail(name);
            } else {
                addSuccess(name);
            }
        }

        function testVar(variable, name, value) {
            if (typeof value == 'undefined' && typeof variable == 'undefined') {
                addFail(name, variable);
            } else if (typeof value != 'undefined' && value !== variable) {
                addFail(name, variable);
            } else {
                addSuccess(name);
            }
        }

        function addFail(name, variable) {
            if (variable) {
                $('body').append('<p class="test">' + name + ': <font color="red">KO (' + variable + ')</font></p>');
            } else {
                $('body').append('<p class="test">' + name + ': <font color="red">KO</font></p>');
            }
        }

        function addSuccess(name) {
            $('body').append('<p class="test">' + name + ': <font color="green">OK</font></p>');
        }

        function testBatchSession() {
            var onBatchSessionTest = false;
            jatos.onBatchSession((path) => {
                onBatchSessionTest = true;
            });

            // clear
            return jatos.batchSession.clear()
                .then(() => {
                    var test = jatos.batchSession.getAll();
                    testVarJson(test, "jatos.batchSession.clear", '{}');
                })

                // set
                .then(() => jatos.batchSession.set("a", "foo"))
                .then(() => {
                    var test = jatos.batchSession.test("/a", "foo");
                    testVarJson(test, "jatos.batchSession.set", "true");
                })

                // setAll
                .then(() => jatos.batchSession.setAll({ "a": "foo", "a2": "foo2" }))
                .then(() => {
                    var test = jatos.batchSession.test("/a", "foo") && jatos.batchSession.test("/a2", "foo2");
                    testVarJson(test, "jatos.batchSession.setAll", "true");
                })

                // add
                .then(() => jatos.batchSession.add("/b", 123))
                .then(() => {
                    var test = jatos.batchSession.test("/b", 123);
                    testVarJson(test, "jatos.batchSession.add", "true");
                })
                
                // add an object
                .then(() => jatos.batchSession.add("/obj", { foo: "bar" }))
                .then(() => {
                    var test = jatos.batchSession.test("/obj/foo", "bar");
                    testVarJson(test, "jatos.batchSession.add(object)", "true");
                })
                
                // add an array
                .then(() => jatos.batchSession.add("/array", [1, 2, 3]))
                .then(() => {
                    var test1 = jatos.batchSession.test("/array/0", 1);
                    var test2 = jatos.batchSession.test("/array/1", 2);
                    var test3 = jatos.batchSession.test("/array/2", 3);
                    testVarJson(test1 && test2 && test3, "jatos.batchSession.add(array)", "true");
                })

                // add an element to an existing array
                .then(() => jatos.batchSession.add("/array/2", "new"))
                .then(() => {
                    var test = jatos.batchSession.test("/array/2", "new");
                    testVarJson(test, "jatos.batchSession.add(add element to array)", "true");
                })
                
                // add an element to the end of an existing array
                .then(() => jatos.batchSession.add("/array/-", "last"))
                .then(() => {
                    var test = jatos.batchSession.test("/array/4", "last");
                    testVarJson(test, "jatos.batchSession.add(add element to end of array)", "true");
                })
                
                // get
                .then(() => {
                    var test = jatos.batchSession.get("a");
                    testVarJson(test, "jatos.batchSession.get", '"foo"');
                })

                // find
                .then(() => {
                    var test = jatos.batchSession.find("/a");
                    testVarJson(test, "jatos.batchSession.find", '"foo"');
                })

                // defined
                .then(() => {
                    var test = jatos.batchSession.defined("/a");
                    testVarJson(test, "jatos.batchSession.defined", "true");
                })
                
                // getAll
                .then(() => {
                    var test = jatos.batchSession.getAll();
                    testVarJson(test, "jatos.batchSession.getAll", '{"a":"foo","a2":"foo2","b":123,"obj":{"foo":"bar"},"array":[1,2,"new",3,"last"]}');
                })
                
                // replace
                .then(() => jatos.batchSession.replace("/a", "bla"))
                .then(() => {
                    var test = jatos.batchSession.test("/a", "bla");
                    testVarJson(test, "jatos.batchSession.replace", "true");
                })
            
                // copy
                .then(() => jatos.batchSession.copy("/a", "/c"))
                .then(() => {
                    var test = jatos.batchSession.test("/a", "bla") && jatos.batchSession.test("/c", "bla");
                    testVarJson(test, "jatos.batchSession.copy", "true");
                })
                
                // move
                .then(() => jatos.batchSession.move("/c", "/d"))
                .then(() => {
                    var test = !jatos.batchSession.defined("/c") && jatos.batchSession.test("/d", "bla");
                    testVarJson(test, "jatos.batchSession.move", "true");
                })

                // remove
                .then(() => jatos.batchSession.remove("/a"))
                .then(() => {
                    var test = jatos.batchSession.test("/a", "foo");
                    testVarJson(test, "jatos.batchSession.remove", "false");
                })

                .then(testBatchSessionVersioning)
                
                // onBatchSession
                .then(() => testVarJson(onBatchSessionTest, "jatos.onBatchSession", "true"))
                .catch(() => addFail("jatos.batchSession"));
        }

        function testBatchSessionVersioning() {
            jatos.batchSessionVersioning = false;
            var promise1 = jatos.batchSession.add("/1_" + jatos.studyResultId, "one");
            var promise2 = jatos.batchSession.add("/2_" + jatos.studyResultId, "two");
            var promise3 = jatos.batchSession.add("/3_" + jatos.studyResultId, "three");
            return Promise.all([promise1, promise2, promise3])
                .then(() => addSuccess("jatos.batchSessionVersioning (off)"))
                .then(() => {

                    jatos.batchSessionVersioning = true;
                    var promise4 = jatos.batchSession.add("/4_" + jatos.studyResultId, "four");
                    var promise5 = jatos.batchSession.add("/5_" + jatos.studyResultId, "five");
                    // The promise must fail now since we send 2 updates simultaneously and versioning is on
                    Promise.all([promise4, promise5])
                        .then(() => addFail("jatos.batchSessionVersioning (on)"))
                        .catch(() => addSuccess("jatos.batchSessionVersioning (on)"));
                })
                .catch(() => addFail("jatos.batchSessionVersioning"));
        }

        function testGroupSession() {
            // join group
            return jatos.joinGroup()

                // clear
                .then(() => jatos.groupSession.clear())
                .then(() => {
                    var test = jatos.groupSession.getAll();
                    testVarJson(test, "jatos.groupSession.clear", '{}');
                })

                // set
                .then(() => jatos.groupSession.set("a", "foo"))
                .then(() => {
                    var test = jatos.groupSession.test("/a", "foo");
                    testVarJson(test, "jatos.groupSession.set", "true");
                })

                // setAll
                .then(() => jatos.groupSession.setAll({ "a": "foo", "a2": "foo2" }))
                .then(() => {
                    var test = jatos.groupSession.test("/a", "foo") && jatos.groupSession.test("/a2", "foo2");
                    testVarJson(test, "jatos.groupSession.set", "true");
                })

                // add
                .then(() => jatos.groupSession.add("/b", 123))
                .then(() => {
                    var test = jatos.groupSession.test("/b", 123);
                    testVarJson(test, "jatos.groupSession.add", "true");
                })
                
                // get
                .then(() => {
                    var test = jatos.groupSession.get("a");
                    testVarJson(test, "jatos.groupSession.get", '"foo"');
                })

                // find
                .then(() => {
                    var test = jatos.groupSession.find("/a");
                    testVarJson(test, "jatos.groupSession.find", '"foo"');
                })

                // defined
                .then(() => {
                    var test = jatos.groupSession.defined("/a");
                    testVarJson(test, "jatos.groupSession.defined", "true");
                })

                // getAll
                .then(() => {
                    var test = jatos.groupSession.getAll();
                    testVarJson(test, "jatos.groupSession.getAll", '{"a":"foo","a2":"foo2","b":123}');
                })

                // replace
                .then(() => jatos.groupSession.replace("/a", "bla"))
                .then(() => {
                    var test = jatos.groupSession.test("/a", "bla");
                    testVarJson(test, "jatos.groupSession.replace", "true");
                })

                // copy
                .then(() => jatos.groupSession.copy("/a", "/c"))
                .then(() => {
                    var test = jatos.groupSession.test("/a", "bla") && jatos.groupSession.test("/c", "bla");
                    testVarJson(test, "jatos.groupSession.copy", "true");
                })

                // move
                .then(() => jatos.groupSession.move("/c", "/d"))
                .then(() => {
                    var test = !jatos.groupSession.defined("/c") && jatos.groupSession.test("/d", "bla");
                    testVarJson(test, "jatos.groupSession.move", "true");
                })

                // remove
                .then(() => jatos.groupSession.remove("/a"))
                .then(() => {
                    var test = jatos.groupSession.test("/a", "foo");
                    testVarJson(test, "jatos.groupSession.remove", "false");
                })

                .then(testGroupSessionVersioning)

                // Leave group
                .then(() => jatos.leaveGroup())
                .catch(() => addFail("jatos.groupSession"));
        }

        function testGroupSessionVersioning() {
            jatos.groupSessionVersioning = false;
            var promise1 = jatos.groupSession.add("/1_" + jatos.studyResultId, "one");
            var promise2 = jatos.groupSession.add("/2_" + jatos.studyResultId, "two");
            var promise3 = jatos.groupSession.add("/3_" + jatos.studyResultId, "three");
            return Promise.all([promise1, promise2, promise3])
                .then(() => addSuccess("jatos.groupSessionVersioning (off)"))
                .then(() => {

                    jatos.groupSessionVersioning = true;
                    var promise4 = jatos.groupSession.add("/4_" + jatos.studyResultId, "four");
                    var promise5 = jatos.groupSession.add("/5_" + jatos.studyResultId, "five");
                    // The promise must fail now since we send 2 updates simultaneously and versioning is on
                    Promise.all([promise4, promise5])
                        .then(() => addFail("jatos.groupSessionVersioning (on)"))
                        .catch(() => addSuccess("jatos.groupSessionVersioning (on)"));
                })
                .catch(() => addFail("jatos.groupSessionVersioning"));
        }

        function testSubmitResultData() {
            var obj = { "obj": "submit" };
            return jatos.submitResultData("submit (this should be overwritten)")
                .then(() => jatos.submitResultData("submit (this should be overwritten too)"))
                .then(() => jatos.submitResultData(obj))
                .then(() => addSuccess("jatos.submitResultData"))
                .catch(() => addFail("jatos.submitResultData"));
        }

        function testAppendResultData() {
            var promise1 = jatos.appendResultData(" ... append 1");
            var promise2 = jatos.appendResultData(" ... append 2");
            var promise3 = jatos.appendResultData(" ... append 3");
            var promise4 = jatos.appendResultData(" ... append 4");
            var promise5 = jatos.appendResultData(" ... append 5");
            var promise6 = jatos.appendResultData(" ... append 6");
            var promise7 = jatos.appendResultData(" ... append 7");
            var promise8 = jatos.appendResultData(" ... append 8");
            var promise9 = jatos.appendResultData(" ... append 9");
            var promise10 = jatos.appendResultData(" ... append 10 ... ");
            var obj = { "obj": "append 11" };
            var promise11 = jatos.appendResultData(obj)

            return Promise.all([promise1, promise2, promise3, promise4, promise5, promise6, promise7, promise8, promise9, promise10, promise11])
                .then(() => addSuccess("jatos.appendResultData"))
                .catch(() => addFail("jatos.appendResultData"));
        }

        function testSetStudySessionData() {
            var test = {
                "a": "foo",
                "b": 123
            };
            return jatos.setStudySessionData(test)
                .then(() => addSuccess("jatos.setStudySessionData"))
                .catch(() => addFail("jatos.setStudySessionData"));
        }

        function testAbortStudyAjax() {
            jatos.abortStudyAjax("Let us abort the study")
                .then(() => addSuccess("jatos.abortStudyAjax"))
                .catch(() => addFail("jatos.abortStudyAjax"));
        }

        function testUpload() {
            var promise1 = fetch("example.video")
                .then(response => response.blob())
                .then(blob => jatos.uploadResultFile(blob, "example.video"))
                .then(() => addSuccess("jatos.uploadResultFile (example.video)"))
                .catch(() => addFail("jatos.uploadResultFile (example.video)"));

            var promise2 = jatos.uploadResultFile({ a: 1, b: "foo" }, "example.json")
                .then(() => addSuccess("jatos.uploadResultFile (example.json)"))
                .catch(() => addFail("jatos.uploadResultFile (example.json)"));

            var promise3 = jatos.uploadResultFile("foobar", "你经常来这吗.txt")
                .then(() => addSuccess("jatos.uploadResultFile (你经常来这吗.txt)"))
                .catch(() => addFail("jatos.uploadResultFile (你经常来这吗.txt)"));

            return Promise.all([promise1, promise2, promise3]);
        }

        function testDownload() {
            var promise1 = jatos.downloadResultFile("example.json")
                .then((obj) => {
                    if (JSON.stringify(obj) == JSON.stringify({ a: 1, b: "foo" })) {
                        addSuccess("jatos.downloadResultFile (example.json)");
                    } else {
                        addFail("jatos.downloadResultFile (example.json)");
                    }
                })
                .catch(() => addFail("jatos.downloadResultFile (example.json)"));

            var promise2 = jatos.downloadResultFile("你经常来这吗.txt")
                .then((text) => {
                    if (text == "foobar") {
                        addSuccess("jatos.downloadResultFile (你经常来这吗.txt)");
                    } else {
                        addFail("jatos.downloadResultFile (你经常来这吗.txt)");
                    }
                })
                .catch(() => addFail("jatos.downloadResultFile (你经常来这吗.txt)"));

            var promise3 = jatos.downloadResultFile("example.video")
                .then((blob) => { 
                    if (blob instanceof Blob) {
                        addSuccess("jatos.downloadResultFile (example.video)")
                    } else {
                        addFail("jatos.downloadResultFile (example.video)");
                    }
                })
                .catch(() => addFail("jatos.downloadResultFile (example.video)"));

            var promise4 = jatos.downloadResultFile("example.video")
                .then((blob) => { 
                    if (blob instanceof Blob) {
                        addSuccess("jatos.downloadResultFile (example.video)")
                    } else {
                        addFail("jatos.downloadResultFile (example.video)");
                    }
                })
                .catch(() => addFail("jatos.downloadResultFile (example.video)"));

            return Promise.all([promise1, promise2, promise3, promise4]);
        }

        function testJatosLog() {
            $('body').append('<p class="test"> jatos.log : ?</p>');
            jatos.log("This is a log test 1 originating in the client side.");
            jatos.log("This is a log test 2 originating in the client side.");
            jatos.log("This is a log test 3 originating in the client side.");
            jatos.log("This is a log test 4 originating in the client side.");
            jatos.log("This is a log test 5 originating in the client side.");
        }

        function testHttpLoopCounter() {
            testVar(jatos.getHttpLoopCounter(), "jatos.getHttpLoopCounter", 26);
        }

        function checkTestNumber() {
            testVar($("p.test").length, "Check test number", 86);
        }

        function callEndStudyAjax() {
            jatos.endStudyAjax({obj:'endStudyAjax append'}, true, 'Test study was finished via Ajax')
                .then(() => console.log2('jatos.endStudyAjax - success'))
                .catch(() => console.log('jatos.endStudyAjax - fail'));
        }

        function callAbortStudyAjax() {
            jatos.abortStudyAjax('Test study was aborted via an Ajax call')
                .then(() => console.log('jatos.abortStudyAjax - success'))
                .catch((error) => console.log('jatos.abortStudyAjax - fail'));
        }

    </script>
</body>